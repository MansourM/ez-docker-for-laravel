#!/usr/bin/env bash
# This script was generated by bashly 1.1.3 (https://bashly.dannyb.co)
# Modifying it manually is not recommended

# :wrapper.bash3_bouncer
if [[ "${BASH_VERSINFO:-0}" -lt 4 ]]; then
  printf "bash version 4 or higher is required\n" >&2
  exit 1
fi

# :command.master_script

# :command.version_command
version_command() {
  echo "$version"
}

# :command.usage
ez_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez - easy to setup, robust and production ready environment for Laravel using Docker, Docker Compose and bash script.\n"
    echo

  else
    printf "ez - easy to setup, robust and production ready environment for Laravel using Docker, Docker Compose and bash script.\n"
    echo

  fi

  printf "%s\n" "Usage:"
  printf "  ez COMMAND\n"
  printf "  ez [COMMAND] --help | -h\n"
  printf "  ez --version | -v\n"
  echo
  # :command.usage_commands
  printf "%s\n" "Commands:"
  printf "  %s   Docker Commands\n" "docker "
  printf "  %s   Shared containers Commands\n" "shared "
  printf "  %s   Laravel containers Commands\n" "laravel"
  printf "  %s   all containers Commands\n" "all    "
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo
    printf "  %s\n" "--version, -v"
    printf "    Show version number\n"
    echo

    # :command.usage_examples
    printf "%s\n" "Examples:"
    printf "  ez docker install\n"
    printf "  ez d i\n"
    echo

  fi
}

# :command.usage
ez_docker_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez docker - Docker Commands\n"
    echo

  else
    printf "ez docker - Docker Commands\n"
    echo

  fi

  printf "Alias: d\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez docker COMMAND\n"
  printf "  ez docker [COMMAND] --help | -h\n"
  echo
  # :command.usage_commands
  printf "%s\n" "Commands:"
  printf "  %s   add docker repository to apt sources, then install docker engine\n" "install  "
  printf "  %s   uninstall docker engine\n" "uninstall"
  printf "  %s   removes all images, containers, and volumes, (You have to delete any edited configuration files manually)\n" "remove   "
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_docker_install_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez docker install - add docker repository to apt sources, then install docker engine\n"
    echo

  else
    printf "ez docker install - add docker repository to apt sources, then install docker engine\n"
    echo

  fi

  printf "Alias: i\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez docker install\n"
  printf "  ez docker install --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_docker_uninstall_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez docker uninstall - uninstall docker engine\n"
    echo

  else
    printf "ez docker uninstall - uninstall docker engine\n"
    echo

  fi

  printf "Alias: u\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez docker uninstall\n"
  printf "  ez docker uninstall --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_docker_remove_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez docker remove - removes all images, containers, and volumes, (You have to delete any edited configuration files manually)\n"
    echo

  else
    printf "ez docker remove - removes all images, containers, and volumes, (You have to delete any edited configuration files manually)\n"
    echo

  fi

  printf "Alias: r\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez docker remove\n"
  printf "  ez docker remove --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_shared_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez shared - Shared containers Commands\n"
    echo

  else
    printf "ez shared - Shared containers Commands\n"
    echo

  fi

  printf "Alias: s\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez shared COMMAND\n"
  printf "  ez shared [COMMAND] --help | -h\n"
  echo
  # :command.usage_commands
  printf "%s\n" "Commands:"
  printf "  %s   build and start shared containers\n" "deploy "
  printf "  %s   start shared containers\n" "start  "
  printf "  %s   stop shared containers\n" "stop   "
  printf "  %s   restart shared containers\n" "restart"
  printf "  %s   remove shared containers\n" "down   "
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_shared_deploy_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez shared deploy - build and start shared containers\n"
    echo

  else
    printf "ez shared deploy - build and start shared containers\n"
    echo

  fi

  printf "Alias: d\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez shared deploy\n"
  printf "  ez shared deploy --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_shared_start_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez shared start - start shared containers\n"
    echo

  else
    printf "ez shared start - start shared containers\n"
    echo

  fi

  printf "Alias: s\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez shared start\n"
  printf "  ez shared start --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_shared_stop_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez shared stop - stop shared containers\n"
    echo

  else
    printf "ez shared stop - stop shared containers\n"
    echo

  fi

  printf "Alias: p\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez shared stop\n"
  printf "  ez shared stop --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_shared_restart_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez shared restart - restart shared containers\n"
    echo

  else
    printf "ez shared restart - restart shared containers\n"
    echo

  fi

  printf "Alias: r\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez shared restart\n"
  printf "  ez shared restart --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_shared_down_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez shared down - remove shared containers\n"
    echo

  else
    printf "ez shared down - remove shared containers\n"
    echo

  fi

  printf "Alias: n\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez shared down\n"
  printf "  ez shared down --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_laravel_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez laravel - Laravel containers Commands\n"
    echo

  else
    printf "ez laravel - Laravel containers Commands\n"
    echo

  fi

  printf "Alias: l\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez laravel COMMAND\n"
  printf "  ez laravel [COMMAND] --help | -h\n"
  echo
  # :command.usage_commands
  printf "%s\n" "Commands:"
  printf "  %s   build and start Laravel containers\n" "deploy "
  printf "  %s   start Laravel containers\n" "start  "
  printf "  %s   stop Laravel containers\n" "stop   "
  printf "  %s   restart Laravel containers\n" "restart"
  printf "  %s   remove Laravel containers\n" "down   "
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_laravel_deploy_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez laravel deploy - build and start Laravel containers\n"
    echo

  else
    printf "ez laravel deploy - build and start Laravel containers\n"
    echo

  fi

  printf "Alias: d\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez laravel deploy APP_ENV\n"
  printf "  ez laravel deploy --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_args
    printf "%s\n" "Arguments:"

    # :argument.usage
    printf "  %s\n" "APP_ENV"
    printf "    Laravel app environment\n"
    printf "    Allowed: test, staging, production\n"
    echo

  fi
}

# :command.usage
ez_laravel_start_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez laravel start - start Laravel containers\n"
    echo

  else
    printf "ez laravel start - start Laravel containers\n"
    echo

  fi

  printf "Alias: s\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez laravel start APP_ENV\n"
  printf "  ez laravel start --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_args
    printf "%s\n" "Arguments:"

    # :argument.usage
    printf "  %s\n" "APP_ENV"
    printf "    Laravel app environment\n"
    printf "    Allowed: test, staging, production\n"
    echo

  fi
}

# :command.usage
ez_laravel_stop_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez laravel stop - stop Laravel containers\n"
    echo

  else
    printf "ez laravel stop - stop Laravel containers\n"
    echo

  fi

  printf "Alias: p\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez laravel stop\n"
  printf "  ez laravel stop --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_laravel_restart_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez laravel restart - restart Laravel containers\n"
    echo

  else
    printf "ez laravel restart - restart Laravel containers\n"
    echo

  fi

  printf "Alias: r\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez laravel restart\n"
  printf "  ez laravel restart --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_laravel_down_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez laravel down - remove Laravel containers\n"
    echo

  else
    printf "ez laravel down - remove Laravel containers\n"
    echo

  fi

  printf "Alias: n\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez laravel down\n"
  printf "  ez laravel down --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_all_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez all - all containers Commands\n"
    echo

  else
    printf "ez all - all containers Commands\n"
    echo

  fi

  printf "Alias: a\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez all COMMAND\n"
  printf "  ez all [COMMAND] --help | -h\n"
  echo
  # :command.usage_commands
  printf "%s\n" "Commands:"
  printf "  %s   build and start all containers\n" "deploy "
  printf "  %s   start all containers\n" "start  "
  printf "  %s   stop all containers\n" "stop   "
  printf "  %s   restart all containers\n" "restart"
  printf "  %s   remove all containers\n" "down   "
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_all_deploy_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez all deploy - build and start all containers\n"
    echo

  else
    printf "ez all deploy - build and start all containers\n"
    echo

  fi

  printf "Alias: d\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez all deploy APP_ENV\n"
  printf "  ez all deploy --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_args
    printf "%s\n" "Arguments:"

    # :argument.usage
    printf "  %s\n" "APP_ENV"
    printf "    Laravel app environment\n"
    printf "    Allowed: test, staging, production\n"
    echo

  fi
}

# :command.usage
ez_all_start_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez all start - start all containers\n"
    echo

  else
    printf "ez all start - start all containers\n"
    echo

  fi

  printf "Alias: s\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez all start APP_ENV\n"
  printf "  ez all start --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

    # :command.usage_args
    printf "%s\n" "Arguments:"

    # :argument.usage
    printf "  %s\n" "APP_ENV"
    printf "    Laravel app environment\n"
    printf "    Allowed: test, staging, production\n"
    echo

  fi
}

# :command.usage
ez_all_stop_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez all stop - stop all containers\n"
    echo

  else
    printf "ez all stop - stop all containers\n"
    echo

  fi

  printf "Alias: p\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez all stop\n"
  printf "  ez all stop --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_all_restart_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez all restart - restart all containers\n"
    echo

  else
    printf "ez all restart - restart all containers\n"
    echo

  fi

  printf "Alias: r\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez all restart\n"
  printf "  ez all restart --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.usage
ez_all_down_usage() {
  if [[ -n $long_usage ]]; then
    printf "ez all down - remove all containers\n"
    echo

  else
    printf "ez all down - remove all containers\n"
    echo

  fi

  printf "Alias: n\n"
  echo

  printf "%s\n" "Usage:"
  printf "  ez all down\n"
  printf "  ez all down --help | -h\n"
  echo

  # :command.long_usage
  if [[ -n $long_usage ]]; then
    printf "%s\n" "Options:"

    # :command.usage_fixed_flags
    printf "  %s\n" "--help, -h"
    printf "    Show this help\n"
    echo

  fi
}

# :command.normalize_input
normalize_input() {
  local arg flags

  while [[ $# -gt 0 ]]; do
    arg="$1"
    if [[ $arg =~ ^(--[a-zA-Z0-9_\-]+)=(.+)$ ]]; then
      input+=("${BASH_REMATCH[1]}")
      input+=("${BASH_REMATCH[2]}")
    elif [[ $arg =~ ^(-[a-zA-Z0-9])=(.+)$ ]]; then
      input+=("${BASH_REMATCH[1]}")
      input+=("${BASH_REMATCH[2]}")
    elif [[ $arg =~ ^-([a-zA-Z0-9][a-zA-Z0-9]+)$ ]]; then
      flags="${BASH_REMATCH[1]}"
      for ((i = 0; i < ${#flags}; i++)); do
        input+=("-${flags:i:1}")
      done
    else
      input+=("$arg")
    fi

    shift
  done
}
# :command.inspect_args
inspect_args() {
  if ((${#args[@]})); then
    readarray -t sorted_keys < <(printf '%s\n' "${!args[@]}" | sort)
    echo args:
    for k in "${sorted_keys[@]}"; do echo "- \${args[$k]} = ${args[$k]}"; done
  else
    echo args: none
  fi

  if ((${#other_args[@]})); then
    echo
    echo other_args:
    echo "- \${other_args[*]} = ${other_args[*]}"
    for i in "${!other_args[@]}"; do
      echo "- \${other_args[$i]} = ${other_args[$i]}"
    done
  fi

  if ((${#deps[@]})); then
    readarray -t sorted_keys < <(printf '%s\n' "${!deps[@]}" | sort)
    echo
    echo deps:
    for k in "${sorted_keys[@]}"; do echo "- \${deps[$k]} = ${deps[$k]}"; done
  fi

}

# :command.user_lib
# src/lib/merge_env.sh
merge_env() {
  local file1="$1"
  local file2="$2"
  local output="$3"

  if [ ! -e "$file1" ]; then
    echo "$file1 does not exist!"
    exit 1
  fi

  if [ ! -e "$file2" ]; then
    echo "$file2 does not exist!"
    exit 1
  fi

  sort -u -t '=' -k 1,1 $file2 $file1 | grep -v '^$\|^\s*\#' > $output

  echo "Merged $file2 into $file1 file creating $output."
}

# src/lib/read_env.sh
read_env() {
  local filePath="${1:-.env}"

  if [ ! -f "$filePath" ]; then
    echo "missing ${filePath}"
    exit 1
  fi

  echo -e "\n==[ Reading $filePath ]==\n"
  while read -r LINE; do
    if [[ $LINE != '#'* ]] && [[ $LINE == *'='* ]]; then
      echo "$LINE"
      export "$LINE"
    fi
  done < "$filePath"
  echo ""
}

# :command.command_functions

# :command.function
ez_docker_install_command() {
  # src/docker_install_command.sh
  #inspect_args

  sudo apt-get update
  sudo apt-get -y install ca-certificates curl gnupg
  sudo install -m 0755 -d /etc/apt/keyrings
  curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
  sudo chmod a+r /etc/apt/keyrings/docker.gpg

  # Add the repository to Apt sources:
  echo \
    "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
      "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" |
    sudo tee /etc/apt/sources.list.d/docker.list >/dev/null
  sudo apt-get update

  sudo apt-get -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # Validate the success of the installation
  if [ $? -ne 0 ]; then
      echo "Failed to install Docker and related packages"
      exit 1
  fi

}

# :command.function
ez_docker_uninstall_command() {
  # src/docker_uninstall_command.sh
  #inspect_args

  sudo apt-get purge docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin docker-ce-rootless-extras

}

# :command.function
ez_docker_remove_command() {
  # src/docker_remove_command.sh
  #inspect_args

  sudo rm -rf /var/lib/docker
  sudo rm -rf /var/lib/containerd

}

# :command.function
ez_shared_deploy_command() {
  # src/shared_deploy_command.sh
  #inspect_args

  # Check if the network already exists
  if docker network inspect "$SHARED_NETWORK_NAME" >/dev/null 2>&1; then
    echo "Network '$SHARED_NETWORK_NAME' already exists"
  else
    docker network create "$SHARED_NETWORK_NAME"
    if [ $? -eq 0 ]; then
      echo "Network '$SHARED_NETWORK_NAME' created"
    else
      echo "Failed to create network '$SHARED_NETWORK_NAME'"
      exit 1
    fi
  fi

  #TODO read APP_ENV from cli args and ignore APP_ENV in .env?
  # Check if APP_ENV is set to dev, test, staging, or production
  if [[ "$APP_ENV" != "dev" && "$APP_ENV" != "test" && "$APP_ENV" != "staging" && "$APP_ENV" != "production" ]]; then
      echo "Error: Invalid value for APP_ENV. It must be either dev, test, staging, or production."
      exit 1
  fi

  echo "Preparing to deploy Laravel in $APP_ENV mode."

  docker compose -f compose-shared.yml --profile "$APP_ENV" up --build -d
  if [ $? -ne 0 ]; then
    echo "Failed to run Docker Compose"
    exit 1
  fi

}

# :command.function
ez_shared_start_command() {
  # src/shared_start_command.sh
  #inspect_args

  docker compose -f compose-shared.yml --profile "$APP_ENV" start

}

# :command.function
ez_shared_stop_command() {
  # src/shared_stop_command.sh
  #inspect_args

  docker compose -f compose-shared.yml --profile "$APP_ENV" stop

}

# :command.function
ez_shared_restart_command() {
  # src/shared_restart_command.sh
  #inspect_args

  docker compose -f compose-shared.yml --profile "$APP_ENV" restart

}

# :command.function
ez_shared_down_command() {
  # src/shared_down_command.sh
  #inspect_args

  docker compose -f compose-shared.yml --profile "$APP_ENV"  down

}

# :command.function
ez_laravel_deploy_command() {
  # src/laravel_deploy_command.sh
  #TODO duplication read APP_ENV from cli args and ignore APP_ENV in .env?
  if [[ "$APP_ENV" != "test" && "$APP_ENV" != "staging" && "$APP_ENV" != "production" ]]; then
      echo "Error: Invalid value for APP_ENV. It must be either test, staging, or production."
      exit 1
  fi

  echo "Preparing to deploy Laravel in $APP_ENV mode."

  #careful with laravel_folder_name, it must be the same as laravel dockerfile and docker compose file
  laravel_folder_name="laravel-$APP_ENV"

  # Check if the folder exists
  if [ -d "$laravel_folder_name" ]; then
      echo "Updating existing $laravel_folder_name folder..."

      cd "$laravel_folder_name" || exit 1
      echo "Remove previous build folders..."
      rm -rf "node_modules" "vendor" "public/build"
      echo "Discard local changes"
      git reset --hard
      git pull origin "$APP_ENV"

      # Check if the git operation was successful
      if [ $? -ne 0 ]; then
          echo "Error: Git pull failed."
          exit 1
      fi

      # Check if the directory removal was successful
      if [ $? -ne 0 ]; then
          echo "Error: Failed to remove build folders."
          exit 1
      fi

      cd - || exit 1
  else
      echo "Cloning new $laravel_folder_name folder..."
      git clone --depth 1 -b "$APP_ENV" "$GIT_URL" "$laravel_folder_name"

      # Check if cloning was successful
      if [ $? -ne 0 ]; then
          echo "Error: Git cloning failed."
          exit 1
      fi
  fi

  # Copy necessary files to the Laravel folder
  env_laravel="env/.env"
  entrypoint_laravel="entrypoint/nginx-fpm-laravel.sh"
  env_override="env/$APP_ENV.env"
  entrypoint_builder="entrypoint/builder-production.sh"
  if [[ "$APP_ENV" == "test" ]]; then
      entrypoint_builder="entrypoint/builder-test.sh"
  fi

  cp "$env_laravel" "$laravel_folder_name/.env"

  cp "$entrypoint_builder" "$laravel_folder_name/entrypoint-builder.sh"
  chmod +x "$laravel_folder_name/entrypoint-builder.sh"

  cp "$entrypoint_laravel" "$laravel_folder_name/entrypoint.sh"
  chmod +x "$laravel_folder_name/entrypoint.sh"

  # Run Docker Compose
  echo "Running Docker Compose for builder..."
  docker compose -f compose-builder.yml --profile "$APP_ENV" --env-file "$env_laravel" --env-file "$env_override" up --build

  echo "Running Docker Compose for Laravel in detached mode..."
  docker compose -f compose-laravel.yml --profile "$APP_ENV" --env-file "$env_laravel"--env-file "$env_override" up --build -d

}

# :command.function
ez_laravel_start_command() {
  # src/laravel_start_command.sh
  #inspect_args

  docker compose -f compose-laravel.yml --profile "$APP_ENV" start

}

# :command.function
ez_laravel_stop_command() {
  # src/laravel_stop_command.sh
  #inspect_args

  docker compose -f compose-laravel.yml --profile "$APP_ENV" stop

}

# :command.function
ez_laravel_restart_command() {
  # src/laravel_restart_command.sh
  #inspect_args

  docker compose -f compose-laravel.yml --profile "$APP_ENV" restart

}

# :command.function
ez_laravel_down_command() {
  # src/laravel_down_command.sh
  #inspect_args

  docker compose -f compose-laravel.yml --profile "$APP_ENV" down

}

# :command.function
ez_all_deploy_command() {
  # src/all_deploy_command.sh
  #inspect_args

  ez_shared_deploy_command
  ez_laravel_deploy_command

}

# :command.function
ez_all_start_command() {
  # src/all_start_command.sh
  #inspect_args

  ez_shared_start_command
  ez_laravel_start_command

}

# :command.function
ez_all_stop_command() {
  # src/all_stop_command.sh
  #inspect_args

  ez_shared_stop_command
  ez_laravel_stop_command

}

# :command.function
ez_all_restart_command() {
  # src/all_restart_command.sh
  #inspect_args

  ez_shared_restart_command
  ez_laravel_restart_command

}

# :command.function
ez_all_down_command() {
  # src/all_down_command.sh
  #inspect_args

  ez_shared_down_command
  ez_laravel_down_command

}

# :command.parse_requirements
parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --version | -v)
        version_command
        exit
        ;;

      --help | -h)
        long_usage=yes
        ez_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action=${1:-}

  case $action in
    -*) ;;

    docker | d)
      action="docker"
      shift
      ez_docker_parse_requirements "$@"
      shift $#
      ;;

    shared | s)
      action="shared"
      shift
      ez_shared_parse_requirements "$@"
      shift $#
      ;;

    laravel | l)
      action="laravel"
      shift
      ez_laravel_parse_requirements "$@"
      shift $#
      ;;

    all | a)
      action="all"
      shift
      ez_all_parse_requirements "$@"
      shift $#
      ;;

    # :command.command_fallback
    "")
      ez_usage >&2
      exit 1
      ;;

    *)
      printf "invalid command: %s\n" "$action" >&2
      exit 1
      ;;

  esac

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_docker_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_docker_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action=${1:-}

  case $action in
    -*) ;;

    install | i)
      action="install"
      shift
      ez_docker_install_parse_requirements "$@"
      shift $#
      ;;

    uninstall | u)
      action="uninstall"
      shift
      ez_docker_uninstall_parse_requirements "$@"
      shift $#
      ;;

    remove | r)
      action="remove"
      shift
      ez_docker_remove_parse_requirements "$@"
      shift $#
      ;;

    # :command.command_fallback
    "")
      ez_docker_usage >&2
      exit 1
      ;;

    *)
      printf "invalid command: %s\n" "$action" >&2
      exit 1
      ;;

  esac

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_docker_install_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_docker_install_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="docker install"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_docker_uninstall_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_docker_uninstall_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="docker uninstall"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_docker_remove_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_docker_remove_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="docker remove"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_shared_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_shared_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action=${1:-}

  case $action in
    -*) ;;

    deploy | d)
      action="deploy"
      shift
      ez_shared_deploy_parse_requirements "$@"
      shift $#
      ;;

    start | s)
      action="start"
      shift
      ez_shared_start_parse_requirements "$@"
      shift $#
      ;;

    stop | p)
      action="stop"
      shift
      ez_shared_stop_parse_requirements "$@"
      shift $#
      ;;

    restart | r)
      action="restart"
      shift
      ez_shared_restart_parse_requirements "$@"
      shift $#
      ;;

    down | n)
      action="down"
      shift
      ez_shared_down_parse_requirements "$@"
      shift $#
      ;;

    # :command.command_fallback
    "")
      ez_shared_usage >&2
      exit 1
      ;;

    *)
      printf "invalid command: %s\n" "$action" >&2
      exit 1
      ;;

  esac

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_shared_deploy_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_shared_deploy_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="shared deploy"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_shared_start_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_shared_start_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="shared start"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_shared_stop_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_shared_stop_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="shared stop"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_shared_restart_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_shared_restart_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="shared restart"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_shared_down_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_shared_down_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="shared down"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_laravel_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_laravel_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action=${1:-}

  case $action in
    -*) ;;

    deploy | d)
      action="deploy"
      shift
      ez_laravel_deploy_parse_requirements "$@"
      shift $#
      ;;

    start | s)
      action="start"
      shift
      ez_laravel_start_parse_requirements "$@"
      shift $#
      ;;

    stop | p)
      action="stop"
      shift
      ez_laravel_stop_parse_requirements "$@"
      shift $#
      ;;

    restart | r)
      action="restart"
      shift
      ez_laravel_restart_parse_requirements "$@"
      shift $#
      ;;

    down | n)
      action="down"
      shift
      ez_laravel_down_parse_requirements "$@"
      shift $#
      ;;

    # :command.command_fallback
    "")
      ez_laravel_usage >&2
      exit 1
      ;;

    *)
      printf "invalid command: %s\n" "$action" >&2
      exit 1
      ;;

  esac

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_laravel_deploy_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_laravel_deploy_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="laravel deploy"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        if [[ -z ${args['APP_ENV']+x} ]]; then

          args['APP_ENV']=$1
          shift
        else
          printf "invalid argument: %s\n" "$key" >&2
          exit 1
        fi

        ;;

    esac
  done

  # :command.required_args_filter
  if [[ -z ${args['APP_ENV']+x} ]]; then
    printf "missing required argument: APP_ENV\nusage: ez laravel deploy APP_ENV\n" >&2
    exit 1
  fi

  # :command.whitelist_filter
  if [[ -n ${args['APP_ENV']:-} ]] && [[ ! ${args['APP_ENV']:-} =~ ^(test|staging|production)$ ]]; then
    printf "%s\n" "APP_ENV must be one of: test, staging, production" >&2
    exit 1
  fi

}

# :command.parse_requirements
ez_laravel_start_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_laravel_start_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="laravel start"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        if [[ -z ${args['APP_ENV']+x} ]]; then

          args['APP_ENV']=$1
          shift
        else
          printf "invalid argument: %s\n" "$key" >&2
          exit 1
        fi

        ;;

    esac
  done

  # :command.required_args_filter
  if [[ -z ${args['APP_ENV']+x} ]]; then
    printf "missing required argument: APP_ENV\nusage: ez laravel start APP_ENV\n" >&2
    exit 1
  fi

  # :command.whitelist_filter
  if [[ -n ${args['APP_ENV']:-} ]] && [[ ! ${args['APP_ENV']:-} =~ ^(test|staging|production)$ ]]; then
    printf "%s\n" "APP_ENV must be one of: test, staging, production" >&2
    exit 1
  fi

}

# :command.parse_requirements
ez_laravel_stop_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_laravel_stop_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="laravel stop"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_laravel_restart_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_laravel_restart_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="laravel restart"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_laravel_down_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_laravel_down_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="laravel down"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_all_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_all_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action=${1:-}

  case $action in
    -*) ;;

    deploy | d)
      action="deploy"
      shift
      ez_all_deploy_parse_requirements "$@"
      shift $#
      ;;

    start | s)
      action="start"
      shift
      ez_all_start_parse_requirements "$@"
      shift $#
      ;;

    stop | p)
      action="stop"
      shift
      ez_all_stop_parse_requirements "$@"
      shift $#
      ;;

    restart | r)
      action="restart"
      shift
      ez_all_restart_parse_requirements "$@"
      shift $#
      ;;

    down | n)
      action="down"
      shift
      ez_all_down_parse_requirements "$@"
      shift $#
      ;;

    # :command.command_fallback
    "")
      ez_all_usage >&2
      exit 1
      ;;

    *)
      printf "invalid command: %s\n" "$action" >&2
      exit 1
      ;;

  esac

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_all_deploy_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_all_deploy_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="all deploy"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        if [[ -z ${args['APP_ENV']+x} ]]; then

          args['APP_ENV']=$1
          shift
        else
          printf "invalid argument: %s\n" "$key" >&2
          exit 1
        fi

        ;;

    esac
  done

  # :command.required_args_filter
  if [[ -z ${args['APP_ENV']+x} ]]; then
    printf "missing required argument: APP_ENV\nusage: ez all deploy APP_ENV\n" >&2
    exit 1
  fi

  # :command.whitelist_filter
  if [[ -n ${args['APP_ENV']:-} ]] && [[ ! ${args['APP_ENV']:-} =~ ^(test|staging|production)$ ]]; then
    printf "%s\n" "APP_ENV must be one of: test, staging, production" >&2
    exit 1
  fi

}

# :command.parse_requirements
ez_all_start_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_all_start_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="all start"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        if [[ -z ${args['APP_ENV']+x} ]]; then

          args['APP_ENV']=$1
          shift
        else
          printf "invalid argument: %s\n" "$key" >&2
          exit 1
        fi

        ;;

    esac
  done

  # :command.required_args_filter
  if [[ -z ${args['APP_ENV']+x} ]]; then
    printf "missing required argument: APP_ENV\nusage: ez all start APP_ENV\n" >&2
    exit 1
  fi

  # :command.whitelist_filter
  if [[ -n ${args['APP_ENV']:-} ]] && [[ ! ${args['APP_ENV']:-} =~ ^(test|staging|production)$ ]]; then
    printf "%s\n" "APP_ENV must be one of: test, staging, production" >&2
    exit 1
  fi

}

# :command.parse_requirements
ez_all_stop_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_all_stop_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="all stop"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_all_restart_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_all_restart_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="all restart"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.parse_requirements
ez_all_down_parse_requirements() {
  # :command.fixed_flags_filter
  while [[ $# -gt 0 ]]; do
    case "${1:-}" in
      --help | -h)
        long_usage=yes
        ez_all_down_usage
        exit
        ;;

      *)
        break
        ;;

    esac
  done

  # :command.command_filter
  action="all down"

  # :command.parse_requirements_while
  while [[ $# -gt 0 ]]; do
    key="$1"
    case "$key" in

      -?*)
        printf "invalid option: %s\n" "$key" >&2
        exit 1
        ;;

      *)
        # :command.parse_requirements_case
        # :command.parse_requirements_case_simple
        printf "invalid argument: %s\n" "$key" >&2
        exit 1

        ;;

    esac
  done

}

# :command.user_hooks
before_hook() {
  # src/before.sh
  inspect_args

  read_env "env/.env"

  #TODO improve here i have duplication in app_env arg and APP_ENV in .env files
  if [[ -z "${args[APP_ENV]}" ]]; then
          echo "Error: 'APP_ENV' is not set or empty. Please set a valid argument." >&2
          exit 1
  fi
  read_env "env/${args[APP_ENV]}.env"

}

# :command.initialize
initialize() {
  version="0.2.0"
  long_usage=''
  set -e

}

# :command.run
run() {
  declare -A args=()
  declare -A deps=()
  declare -a other_args=()
  declare -a input=()
  normalize_input "$@"
  parse_requirements "${input[@]}"
  before_hook

  case "$action" in
    "docker") ez_docker_command ;;
    "docker install") ez_docker_install_command ;;
    "docker uninstall") ez_docker_uninstall_command ;;
    "docker remove") ez_docker_remove_command ;;
    "shared") ez_shared_command ;;
    "shared deploy") ez_shared_deploy_command ;;
    "shared start") ez_shared_start_command ;;
    "shared stop") ez_shared_stop_command ;;
    "shared restart") ez_shared_restart_command ;;
    "shared down") ez_shared_down_command ;;
    "laravel") ez_laravel_command ;;
    "laravel deploy") ez_laravel_deploy_command ;;
    "laravel start") ez_laravel_start_command ;;
    "laravel stop") ez_laravel_stop_command ;;
    "laravel restart") ez_laravel_restart_command ;;
    "laravel down") ez_laravel_down_command ;;
    "all") ez_all_command ;;
    "all deploy") ez_all_deploy_command ;;
    "all start") ez_all_start_command ;;
    "all stop") ez_all_stop_command ;;
    "all restart") ez_all_restart_command ;;
    "all down") ez_all_down_command ;;
  esac
}

initialize
run "$@"
